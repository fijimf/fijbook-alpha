@import controllers.nav.Breadcrumbs
@import controllers.nav.MainMeta
@import com.fijimf.deepfij.models.User
@import com.fijimf.deepfij.models.Season
@import com.fijimf.deepfij.models.GamePrediction
@import com.fijimf.deepfij.models.Team
@import com.fijimf.deepfij.models.Schedule
@import com.fijimf.deepfij.models.TeamPredictionView
@import java.time.format.DateTimeFormatter
@import java.time.LocalDate
@import org.apache.commons.lang3.StringUtils
@import controllers.LogisticPerformanceSummary
@import helper._
@import com.fijimf.deepfij.models.react.DisplayUser
@import com.fijimf.deepfij.models.react.QuoteWrapper
@(
        displayUser: DisplayUser, quoteWrapper: QuoteWrapper,
        seasons:List[Season],
        teams:List[Team],
        features:List[(String, String)],
        normalizations:List[(String, String)],
        form:Form[forms.PredictionModelForm.Data],
        datePredictions:List[(LocalDate, List[GamePrediction])],
        teamPredictions:List[TeamPredictionView],
        ps:LogisticPerformanceSummary,
        sch:Schedule,
        featureCoefficients:List[(String, Double)],
        mode:String
)(implicit request: RequestHeader, flash: Flash, messages: Messages)

@implicitFieldConstructor = @{
    b3.vertical.fieldConstructor
}

    @main3000(displayUser,quoteWrapper) {
    <div class="row">
        <ul class="nav nav-tabs" role="tablist">
            @if(mode=="request") {
                <li role="presentation" class="active"><a href="#request" aria-controls="request" role="tab" data-toggle="tab">
                    Request</a></li>
                <li role="presentation"><a href="#predictions" aria-controls="predictions" role="tab" data-toggle="tab">
                    Predictions</a></li>
            } else {
                <li role="presentation" ><a href="#request" aria-controls="request" role="tab" data-toggle="tab">
                    Request</a></li>
                <li role="presentation" class="active"><a href="#predictions" aria-controls="predictions" role="tab" data-toggle="tab">
                    Predictions</a></li>
            }
            <li role="presentation"><a href="#performance" aria-controls="performance" role="tab" data-toggle="tab">Model performance</a></li>
            <li role="presentation"><a href="#trainingSet" aria-controls="trainingSet" role="tab" data-toggle="tab">Training set</a></li>
        </ul>
    </div>
    <div class="tab-content">
    @if(mode=="request") {
        <div role="tabpanel" class="tab-pane active" id="request">
        }else{
        <div role="tabpanel" class="tab-pane" id="request">
        }
            <div class="row">
                <div class="col-sm-10">
                    <h4>Logistic Regression</h4>
                    <p>
                        In statistics, <a href="https://en.wikipedia.org/wiki/Logistic_regression" target="_blank">logistic regression</a> or logit model is a regression model where the dependent variable is categorical.
                        The simplest case is that of a binary dependent variable &mdash; that is, where the output can take only two values, "1" and "0", which in our case represent "wins" and "loses".
                        The binary logistic model is used to estimate the probability of the binary response based on one or more predictors (independent variables), also called features.
                    </p>
                    <p>This page lets you experiment with various potential logit models.</p>
                </div>
                <div class="col-sm-12">
                @b3.form(routes.PredictionModelController.logisticRun()) {
                    <div class="row">
                        @CSRF.formField
                        <div class="col-sm-4">
                            <div class="panel panel-default" style="margin: 5px; height: available;">
                                <div class="panel-heading">
                                    <h3 class="panel-title">Training Data &emsp;<a href="#" data-toggle="modal" data-target="#trainingDataInfo"><i class="fa fa-question-circle-o"></i></a></h3>
                                </div>
                                @b3.select(form("seasons"), seasons.map(s => s.year.toString -> s.year.toString), '_label->"Seasons", 'multiple -> true, 'size -> seasons.size, 'class->"deepfij100-input", '_class->"deepfij100-fg")
                                @b3.select(form("excludeMonths"),
                                    List(
                                        "11"->"November",
                                        "12"->"December",
                                        "1"->"January",
                                        "2"->"February",
                                        "3"->"March",
                                        "4"->"April"), '_label->"Exclude Months", 'multiple -> true, 'size -> 6, 'class->"deepfij100-input", '_class->"deepfij100-fg")
                            </div><div>
                        @b3.submit('class -> "btn btn-lg btn-success") { Run/Classify }
                        </div>
                        </div>
                        <div class="col-sm-4">
                            <div class="panel panel-default" style="margin: 5px; height: available;">
                                <div class="panel-heading">
                                    <h3 class="panel-title">Feature Mapping &emsp;<a href="#" data-toggle="modal" data-target="#featureMappingInfo"><i class="fa fa-question-circle-o"></i></a></h3>
                                </div>
                                @b3.select(form("features"),features,'_label->"Computed Statistics",'multiple->true, 'size->10, 'class->"deepfij100-input", '_class->"deepfij100-fg")
                                @b3.radio(form("normalization"), options = normalizations, '_label -> "Normalization", 'class->"deepfij100-input", '_class->"deepfij100-fg")
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class="panel panel-default" style="margin: 5px; height: available;">
                                <div class="panel-heading">
                                    <h3 class="panel-title">Prediction &emsp;<a href="#" data-toggle="modal" data-target="#predictionInfo"><i class="fa fa-question-circle-o"></i></a></h3>
                                </div>
                                @b3.select(form("predictTeams"),teams.sortBy(_.name).map(s=>s.key.toString->s.name),'_label->"Results for",'multiple->true, 'size->20, 'class->"deepfij100-input", '_class->"deepfij100-fg")
                                @b3.hidden(form("predictFrom"),'_label->"From Date", 'class->"deepfij100-input", '_class->"deepfij100-fg")
                                @b3.hidden(form("predictTo"),'_label->"To Date", 'class->"deepfij100-input", '_class->"deepfij100-fg")
                            </div>
                        </div>

                    </div>
                }
                </div>
                    <!-- Modal -->
                <div class="modal fade" id="trainingDataInfo" tabindex="-1" role="dialog" aria-labelledby="trainingDataLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header" style="background-color: #f5f5f5;
                                color: #337ab7;">
                                <h3 class="modal-title" id="trainingDataLabel">Training Data</h3>
                            </div>
                            <div class="modal-body">
                                <h4>Seasons</h4>
                                <p>Allows the user to select which seasons should be included to train the model.</p>
                                <h4>Exclude months</h4>
                                <p>Allows the user to exclude certain months from the training set.
                                    Typically November is skipped because any feature mapping which uses computed statistics might be erratic at the very start of the season.
                                    Additionally March/April are sometimes exclude, because the intent is to predict the result of the NCAA tournament and excluding those months will prevent overfitting</p>

                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-primary" data-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal fade" id="featureMappingInfo" tabindex="-1" role="dialog" aria-labelledby="featureMappingLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header" style="background-color: #f5f5f5;
                                color: #337ab7;">
                                <h3 class="modal-title" id="featureMappingLabel">Feature Mapping</h3>
                            </div>
                            <div class="modal-body">
                                <h4>Computed Statistics</h4>
                                <p>Allows the user to select factors will be used to regress against.  The statitsics
                                    listed are computed for each team for every day during the season.  With repect to
                                    classifying a game, we consider the difference between values for each of the two
                                    teams in the game, at the time of the game.
                                </p>
                                <h4>Normalization</h4>
                                <p>Normalizes the values for the teams based on the population of the statistic at the
                                    point in time.  Z-score takes the raw value of the statistic, subtracts the
                                    population mean and divides by the population standard deviation.  The result is the
                                    number of S.D.'s from the mean.  Min-max subtracts the min and divides by the range
                                    between the min and max.  The resulting population is always bounded between 0..1.
                                No normalization leaves raw scores.</p>
                                <p>
                                    Without going into great detail, in general, normalization is a good idea, especially if the scale of different
                                    features is very different.  Z-score is typically better.
                                </p>

                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-primary" data-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal fade" id="predictionInfo" tabindex="-1" role="dialog" aria-labelledby="predictionLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header" style="background-color: #f5f5f5;
                                color: #337ab7;">
                                <h3 class="modal-title" id="predictionLabel">Prediction</h3>
                            </div>
                            <div class="modal-body">
                                <h4>Teams</h4>
                                <p>Which teams to generate reports for..</p>

                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-primary" data-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>





            </div>
        </div>
            @if(mode=="request") {
        <div role="tabpanel" class="tab-pane" id="predictions">
        }else{
        <div role="tabpanel" class="tab-pane active" id="predictions">
        }
            <div class="row">
                <h3 class="col-sm-12"> Predictions</h3>
                @for(d<-datePredictions){
                    <div class="col-sm-12">
                        <h4>Predicted results for @d._1.format(DateTimeFormatter.ofPattern("yyyy-MM-dd"))</h4>
                        <table class="table table-sm table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Home</th>
                                    <th>Prob</th>
                                    <th>Away</th>
                                    <th>Prob</th>
                                </tr>
                            </thead>
                            <tbody>
                            @for(g<-d._2){
                                <tr>
                                @defining(sch.gameMap.get(g.gameId)){ optGame=>
                                    <td> @{optGame.map(_.date.format(DateTimeFormatter.ofPattern("yyyy-MM-dd"))).getOrElse("")} </td>
                                    <td> @{optGame.map(_.homeTeamId).flatMap(tid=>sch.teamsMap.get(tid)).map(_.name).getOrElse("")} </td>
                                @if(optGame.map(_.homeTeamId) == g.favoriteId){
                                    <td>@{g.probability.map(x=>x.formatted("%6.4f")).getOrElse("-")}</td>
                                }
                                @if(optGame.map(_.awayTeamId) == g.favoriteId){
                                    <td>@{g.probability.map(x=>(1.0-x).formatted("%6.4f")).getOrElse("-")} </td>
                                }
                                    <td> @{optGame.map(_.awayTeamId).flatMap(tid=>sch.teamsMap.get(tid)).map(_.name).getOrElse("")} </td>
                                @if(optGame.map(_.homeTeamId) == g.favoriteId){
                                    <td>@{g.probability.map(x=>(1.0-x).formatted("%6.4f")).getOrElse("-")}</td>
                                }
                                @if(optGame.map(_.awayTeamId) == g.favoriteId){
                                    <td>@{g.probability.map(x=>x.formatted("%6.4f")).getOrElse("-")}</td>
                                }
                                }
                                </tr>
                            }
                            </tbody>

                        </table>
                    </div>
                }
            </div>
            <div class="row">
            @for(t<-teamPredictions){
                <div class="col-sm-12">
                    <h2><img src=@t.t.logoSmUrl.getOrElse("#") />@t.t.name @t.t.nickname</h2>
                </div>
                <div class="col-sm-6">
                    <h4>Results</h4>
                    <table class="table table-smushed table-bordered table-striped">
                        <thead/>
                        <tbody>
                            <tr><th>Games Predicted</th><td>@t.numPredicted</td></tr>
                            <tr><th>Games Predicted Correctly</th><td>@t.numCorrect (@{(t.pctCorrect*100).formatted("%5.1f%%")})</td></tr>
                            <tr><th>Realized Record</th><td>@t.realizedRecord.won - @t.realizedRecord.lost </td></tr>
                            <tr><th>Expected Record</th><td>@t.expectedRecord.won - @t.expectedRecord.lost </td></tr>
                        </tbody>
                    </table>
                    <h4>Feature Coefficients</h4>
                    <table class="table table-smushed table-bordered table-striped">
                        <thead/>
                        <tbody>
                            @for(fc<-featureCoefficients){
                                <tr><th>@fc._1</th><td>@fc._2.formatted("%7.4f")</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="col-sm-3">
       <h4>Distribution of W-L</h4>
                    <table class="table table-smushed table-bordered table-striped">
                        <thead>
                            <th>W-L</th>
                            <th>%</th>
                        </thead>
                        <tbody>
                    @for(rd<-t.recordDistribution){
                        <tr>
                                <th class="text-center">@rd._1.won.formatted("%-2d") - @rd._1.lost.formatted("%-2d")</th>
                                <td class="text-center">@{(100.0*rd._2).formatted("%7.3f%%")}</td>
                        </tr>
                    }
                        </tbody>
                    </table>
                </div>
                <div class="col-sm-12">

                <table class="table table-smushed table-bordered">
                        <thead>
                            <tr>
                                <th></th>
                                <th>W/L</th>
                                <th>Odds</th>
                                <th>Date</th>
                                <th>Home</th>
                                <th>Score</th>
                                <th>Prob</th>
                                <th>Away</th>
                                <th>Score</th>
                                <th>Prob</th>
                            </tr>
                        </thead>
                        <tbody>
                        @for(g<-t.ps){
                            <tr>
                                <td>
                                    @if(g.isResultCorrect.getOrElse(false)){
                                        <span class="fa fa-check-circle" style="color: #00f; font-weight: bold"> </span>
                                    } else {
                                        @if(g.hasResult) {
                                            <span class="fa fa-times-circle" style="color: #999;
                                                font-weight: bold"> </span>
                                        }else {
                                            <span></span>
                                        }
                                    }
                                </td>
                                <td>
                                    @if(g.hasResult){
                                        @if(g.isWinner(t.t)) {
                                            <span style="color: #0d0; font-weight: bold">W</span>
                                        } else {
                                            <span style="color: #f00; font-weight: bold">L</span>
                                        }
                                    } else {
                                        @if(g.isFavorite(t.t)) {
                                            <span style="color: #7a7; font-weight: bold">(W)</span>
                                        } else {
                                            <span style="color: #b77; font-weight: bold">(L)</span>
                                        }

                                    }
                                </td>
                                <td class="text-right">@if(g.odds(t.t).isDefined){
                                    @if(g.odds(t.t).get<=1.0) {
                                        <span style="color: #b77;" >1 : @g.odds(t.t).map(1.0/_).get.formatted("%5.1f")</span>
                                    } else {
                                        <span style="color: #7a7;">@g.odds(t.t).get.formatted("%5.1f") : 1</span>
                                    }
                                }</td>
                                <td> @{g.dateStr} </td>
                                <td> @{g.homeTeam.name} </td>
                                <td> @{g.result.map(_.homeScore.toString).getOrElse("")} </td>
                                <td> @{g.homeProb.map(x=>x.formatted("%6.4f")).getOrElse("-")} </td>
                                <td> @{g.awayTeam.name} </td>
                                <td> @{g.result.map(_.awayScore.toString).getOrElse("")} </td>
                                <td> @{g.awayProb.map(x=>x.formatted("%6.4f")).getOrElse("-")}</td>
                            </tr>
                        }
                        </tbody>

                    </table>
                </div>
            }
            </div>
        </div>
        <div role="tabpanel" class="tab-pane" id="performance">
            <div class="row">
                <div class="col-sm-6">
                    <h4>Overall Model Performance</h4>
                    <table class="table table-sm table-bordered table-striped">
                        <thead>
                            <th></th>
                            <th>Games</th>
                            <th>Correct</th>
                            <th>Incorrect</th>
                            <th>%</th>
                            <th>&mu; Log Likelihood</th>
                        </thead>
                        <tbody>
                        @for(s<-ps.overallSplit.sortBy(_.key)) {
                            <tr>
                                <td class="text-right">@s.key</td>
                                <td class="text-right">@s.n</td>
                                <td class="text-right">@s.correct</td>
                                <td class="text-right">@s.incorrect</td>
                                <td class="text-right">@s.pctCorrect.formatted("%7.4f")</td>
                                <td class="text-right">@s.avgLogLikelihood.formatted("%7.4f")</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                    <h4>Model Performance by Estimated Probability</h4>
                    <table class="table table-sm table-bordered table-striped">
                        <thead>
                            <th>Probability</th>
                            <th>Games</th>
                            <th>Correct</th>
                            <th>Incorrect</th>
                            <th>%</th>
                            <th>&mu; Log Likelihood</th>
                        </thead>
                        <tbody>
                        @for(s<-ps.splitByPct.sortBy(_.key)) {
                            <tr>
                                <td>@s.key</td>
                                <td class="text-right">@s.n (@{(100.0*s.n/ps.splitByPct.map(_.n).sum).formatted("%4.1f%%")})</td>
                                <td class="text-right">@s.correct</td>
                                <td class="text-right">@s.incorrect</td>
                                <td class="text-right">@s.pctCorrect.formatted("%7.4f")</td>
                                <td class="text-right">@s.avgLogLikelihood.formatted("%7.4f")</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
                <div class="col-sm-6">
                    <h4>Model Performance by Season/Month</h4>
                    <table class="table table-sm table-bordered table-striped">
                        <thead>
                            <th>Season</th>
                            <th>Month</th>
                            <th>Games</th>
                            <th>Correct</th>
                            <th>Incorrect</th>
                            <th>%</th>
                            <th>&mu; Log Likelihood</th>
                        </thead>
                        <tbody>
                        @for(s<-ps.seasonMonthSplits.sortBy(_.key._2.toEpochDay)) {
                            <tr>
                                <td>@s.key._1.year</td>
                                <td>@s.key._2.format(DateTimeFormatter.ofPattern("MMMM"))</td>
                                <td class="text-right" > @s.n (@{(100.0*s.n/ps.seasonMonthSplits.map(_.n).sum).formatted("%4.1f%%")})</td>
                                <td class="text-right" >@s.correct</td>
                                <td class="text-right" >@s.incorrect</td>
                                <td class="text-right" >@s.pctCorrect.formatted("%7.4f")</td>
                                <td class="text-right">@s.avgLogLikelihood.formatted("%7.4f")</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>

            </div>
            <div class="row">
                <div class="col-sm-6">
                    <h4>Best 25 Team/Season Model Performance</h4>
                    <table class="table table-sm table-bordered table-striped">
                        <thead>
                            <th>Season</th>
                            <th>Team</th>
                            <th>Games</th>
                            <th>Correct</th>
                            <th>Incorrect</th>
                            <th>%</th>
                            <th>&mu; Log Likelihood</th>
                        </thead>
                        <tbody>
                        @for(s<-ps.seasonTeamSplit.sortBy(t=> t.avgLogLikelihood).take(25)) {
                            <tr>
                                <td>@s.key._1.year</td>
                                <td>@s.key._2.name</td>
                                <td class="text-right">@s.n (@{(100.0*s.n/ps.seasonTeamSplit.map(_.n).sum).formatted("%4.1f%%")})</td>
                                <td class="text-right">@s.correct</td>
                                <td class="text-right">@s.incorrect</td>
                                <td class="text-right">@s.pctCorrect.formatted("%7.4f")</td>
                                <td class="text-right">@s.avgLogLikelihood.formatted("%7.4f")</td>
                            </tr>
                        }

                        </tbody>
                    </table>
                </div>
                <div class="col-sm-6">
                    <h4>Worst 25 Team/Season Model Performance</h4>
                    <table class="table table-sm table-bordered table-striped">
                        <thead>
                            <th>Season</th>
                            <th>Team</th>
                            <th>Games</th>
                            <th>Correct</th>
                            <th>Incorrect</th>
                            <th>%</th>
                            <th>&mu; Log Likelihood</th>
                        </thead>
                        <tbody>
                        @for(s<-ps.seasonTeamSplit.sortBy(t=> -t.avgLogLikelihood).take(25)) {
                            <tr>
                                <td>@s.key._1.year</td>
                                <td>@s.key._2.name</td>
                                <td class="text-right">@s.n (@{(100.0*s.n/ps.seasonTeamSplit.map(_.n).sum).formatted("%4.1f%%")})</td>
                                <td class="text-right">@s.correct</td>
                                <td class="text-right">@s.incorrect</td>
                                <td class="text-right">@s.pctCorrect.formatted("%7.4f")</td>
                                <td class="text-right">@s.avgLogLikelihood.formatted("%7.4f")</td>
                            </tr>
                        }

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div role="tabpanel" class="tab-pane" id="trainingSet">
            <div class="row">
                <div class="col-sm-12">
                    <h4>Complete Training Set Results</h4>
                    <table class="table table-smushed table-bordered table-striped">
                        <thead><tr>
                            <th>Game Time</th>
                            <th>Home</th>
                            <th></th>
                            <th>Away</th>
                            <th></th>
                            <th>Probabilities</th>
                            <th>Correct</th>
                            <th>Log Likelihood</th>
                        </tr></thead>
                        <tbody >
                        @for(l<-ps.ls){
                            <tr>
                                <td>@{l.game.datetime.format(DateTimeFormatter.ISO_LOCAL_DATE_TIME)}</td>
                                <td>@{sch.teamsMap(l.game.homeTeamId).name}</td>
                                <td>@{l.homeScore.toString}</td>
                                <td>@{sch.teamsMap(l.game.awayTeamId).name}</td>
                                <td>@{l.awayScore.toString}</td>
                                <td>[@{l.homePct.formatted("%6.4f")}, @{l.awayPct.formatted("%6.4f")}]</td>
                                @if(l.correct){
                                    <td style="color:green;"><i class="fa fa-check-circle" ></i></td>
                                }else{
                                    <td style="color:red;"><i class="fa fa-times-circle" ></td>
                                }
                                <td>@{l.logLikelihood.formatted("%6.4f")}</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
}
